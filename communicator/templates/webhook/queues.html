<!DOCTYPE html>
<html lang="en">

  {% include 'head.html' %}

  <body>

  {% include 'header/header-top.html' %}

  <div class="container">

    {% include 'header/header-left.html' %}

    <div class="container-main">
        <div class="breadcrumb">
            <div class="breadcrumb-navigation flex flex-align-center">
                {% include 'header/icons/icon-breadcrumb.html' %}
            </div>
            <div class="breadcrumb-heading flex flex-align-center">
                <div class="breadcrumb-heading-previous ml-15">
                    Черги
                </div>
            </div>
        </div>

        <div class="content">
            <div class="content-wrapper">
                <div class="content-wrapper-head">
                    <div class="content-head-heading">
                        <div class="content-wrapper-head-header-heading">
                            Черги
                        </div>
                        <div class="content-wrapper-head-header-description">
                            Моніторинг
                        </div>
                    </div>
                    <div class="content-wrapper-head-actions">
                        <div class="flex flex-direction-row justify-content-between ml-15">
                          <label class="label label-required_danger" style="width: 100%">Автооновлення</label>
                          <div class="w-100">
                            <span id="toggleActive">
                              <span onclick="toggleAutorefresh()">
                                  {% include 'header/icons/icon-square-checked.html' %}
                                  <input type="hidden" checked id="autorefresh-switch">
                              </span>
                            </span>
                          </div>
                      </div>
                    </div>
                </div>

                {% set headings = [
                    {'name': 'Назва черги'},
                    {'name': 'У черзі'},
                    {'name': 'Розпочатих'},
                    {'name': 'Неуспішних'},
                    {'name': 'Відкладених'},
                    {'name': 'Завершених'},
                    {'name': 'Дії', 'actions': True},
                ] %}

                <div class="table-header">
                   {% for heading in headings %}
                    <div style="width: {% if heading.actions %}50px{% else %}16%{% endif %};">
                        {{ heading.name }}
                    </div>
                    {% endfor %}
                </div>

                <div class="content-wrapper-info">
                    <div class="table-content">
                        {% if not queue_data %}
                        <div class="table-row">
                            <div style="width: 100%; text-align: center">
                                Немає черг
                            </div>
                        </div>
                        {% endif %}
                        {% for queue_stats in queue_data %}
                        <div class="table-row">
                            <div style="width: 17%">
                              <a href="{{baseurl}}/webhooks/jobs?queue={{ queue_stats.queue_name }}">
                                {{ queue_stats.queue_name }}
                              </a>
                            </div>
                            <div style="width: 17%">
                                <a
                                    href="{{baseurl}}/webhooks/jobs?queue={{ queue_stats.queue_name }}&state=queued"
                                  >
                                    {{ queue_stats.queued }}
                                  </a>
                            </div>
                            <div style="width: 17%">
                              <a
                                href="{{baseurl}}/webhooks/jobs?queue={{ queue_stats.queue_name }}&state=started"
                              >
                                {{ queue_stats.started }}
                              </a>
                            </div>
                            <div style="width: 17%">
                              <a
                                href="{{baseurl}}/webhooks/jobs?queue={{ queue_stats.queue_name }}&state=failed"
                              >
                                {{ queue_stats.failed }}
                              </a>
                            </div>
                            <div style="width: 17%">
                              <a
                                href="{{baseurl}}/webhooks/jobs?queue={{ queue_stats.queue_name }}&state=deferred"
                              >
                                {{ queue_stats.deferred }}
                              </a>
                            </div>
                            <div style="width: 17%">
                              <a
                                href="{{baseurl}}/webhooks/jobs?queue={{ queue_stats.queue_name }}&state=finished"
                              >
                                {{ queue_stats.finished }}
                              </a>
                            </div>

                            <div style="width: 50px">
                                <div class="is-flex-direction-row is-align-content-center">
                                    <a onclick="deleteJobsInQueue('{{ queue_stats.queue_name }}')" style="color: #00475A">
                                       {% include 'header/icons/icon-delete.html' %}
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

  <script>
      let autoRefreshEnabled = true;
      let autoRefreshInterval;
      const protocol = '{{ protocol }}';
      const host = window.location.host;
      const prefix = '{{ prefix }}';
      const baseurl = protocol + '://' + host + prefix;
      function showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          document.body.removeChild(notification);
        }, 3000);
      }

      function showErrorNotification(message) {
        const notification = documenr.createElement('div');
        notification.className = 'error-notification';
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
          document.body.removeChild(notification);
        }, 3000);
      }

      function toggleAutorefresh() {
        autoRefreshEnabled = !autoRefreshEnabled;
        if (autoRefreshEnabled) {
          autoRefreshInterval = setInterval(updateQueuesData, 5000);
        } else {
          clearInterval(autoRefreshInterval);
        }

        const activeSpan = document.getElementById('toggleActive');
        if (!autoRefreshEnabled) {
            activeSpan.innerHTML = `
                <span onclick="toggleAutorefresh()">
                    {% include 'header/icons/icon-square.html' %}
                    <input type="hidden" id="autorefresh-switch">
                </span>`;
        } else {
            activeSpan.innerHTML = `
                <span onclick="toggleAutorefresh()">
                    {% include 'header/icons/icon-square-checked.html' %}
                    <input type="hidden" checked id="autorefresh-switch">
                </span>`;
        }
      }

      $(document).ready(function () {
        $('#autorefresh-switch').on('change', function () {
          toggleAutorefresh();
        });
        autoRefreshEnabled = document.getElementById("autorefresh-switch").hasAttribute('checked');
        if (autoRefreshEnabled) {
          autoRefreshInterval = setInterval(updateQueuesData, 5000);
        }
      });

      function updateQueuesData() {
        if (autoRefreshEnabled) {
          $.ajax({
            url: baseurl + '/queues/json',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
              updateQueuesTable(data);
            },
            error: function (error) {
              console.error('Error fetching queues data: ', error);
              showErrorNotification('Error fetching queues data');
            },
          });
        }
      }

      function deleteJobsInQueue(queue_name) {
        $.ajax({
          url: baseurl + '/queues/' + queue_name,
          type: 'DELETE',
          error: function (error) {
            console.error('Error deleting jobs in queue: ', error);
            showErrorNotification('Error deleting job');
          },
        });
      }

      function updateQueuesTable(data) {
        var tableBody = $('#queues tbody');

        if (tableBody.children().length > 0) {
          tableBody.empty();
        }

        $.each(data, function (index, queue_stats) {
          var row = $('<tr>');
          row.append($('<td>').text(queue_stats.queue_name));
          row.append(
            $('<td>').append(
              $('<a>')
                .attr(
                  'href',
                  baseurl +
                    '/jobs' +
                    '?state=queued&queue_name=' +
                    queue_stats.queue_name
                )
                .text(queue_stats.queued)
            )
          );
          row.append(
            $('<td>').append(
              $('<a>')
                .attr(
                  'href',
                  baseurl +
                    '/jobs' +
                    '?state=started&queue_name=' +
                    queue_stats.queue_name
                )
                .text(queue_stats.started)
            )
          );
          row.append(
            $('<td>').append(
              $('<a>')
                .attr(
                  'href',
                  baseurl +
                    '/jobs' +
                    '?state=failed&queue_name=' +
                    queue_stats.queue_name
                )
                .text(queue_stats.failed)
            )
          );
          row.append(
            $('<td>').append(
              $('<a>')
                .attr(
                  'href',
                  baseurl +
                    '/jobs' +
                    '?state=deferred&queue_name=' +
                    queue_stats.queue_name
                )
                .text(queue_stats.deferred)
            )
          );
          row.append(
            $('<td>').append(
              $('<a>')
                .attr(
                  'href',
                  baseurl +
                    '/jobs' +
                    '?state=finished&queue_name=' +
                    queue_stats.queue_name
                )
                .text(queue_stats.finished)
            )
          );
          row.append(
            $('<td>').append(
              $('<button>')
                .text('Delete')
                .addClass('delete-button')
                .on('click', function () {
                  deleteJobsInQueue(queue_stats.queue_name);
                })
            )
          );
          tableBody.append(row);
        });
      }

      $(document).ready(function () {
        updateQueuesData();
      });

      if (autoRefreshEnabled) {
        setInterval(updateQueuesData, 5000);
      }
    </script>
  </body>
</html>